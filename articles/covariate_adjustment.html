<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Covariate adjustment • CSCORE</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Covariate adjustment">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">CSCORE</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.2</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/CSCORE.html">Get started</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-vignettes" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Vignettes</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-vignettes">
<li><a class="dropdown-item" href="../articles/CSCORE.html">CS-CORE</a></li>
    <li><a class="dropdown-item" href="../articles/covariate_adjustment.html">Covariates adjustment</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav"></ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Covariate adjustment</h1>
            
      

      <div class="d-none name"><code>covariate_adjustment.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="motivation">Motivation<a class="anchor" aria-label="anchor" href="#motivation"></a>
</h2>
<p>The original implementation of CS-CORE does not consider covariate
adjustment. For example, in the <a href="https://www.nature.com/articles/s41467-023-40503-7" class="external-link">paper</a>, we
assumed</p>
<p><span class="math display">\[
{\bf z_{i}}\sim F_p({\bf \mu}, \Sigma), x_{ij}|z_{ij} \sim
\text{Poisson}(s_i z_{ij})
\]</span></p>
<p>such that the mean <span class="math inline">\({\bf \mu}\)</span> and
the variance-covariance matrix <span class="math inline">\(\Sigma\)</span> of underlying gene expression are
exactly the same for all cells in the population. However, in real data,
it is possible that the mean, variance, and co-expression of underlying
gene expression could be affected by technical covariates (such as
percent.mt) or biological covariates (such as sex) that vary across
cell.</p>
</div>
<div class="section level2">
<h2 id="new-moment-based-regressions-for-covariate-adjustment">New moment-based regressions for covariate adjustment<a class="anchor" aria-label="anchor" href="#new-moment-based-regressions-for-covariate-adjustment"></a>
</h2>
<p>In June 2025, we added a new feature to CS-CORE that allows adjusting
for covariates in co-expression inference. In particular, we adjust for
covariates through modelling <span class="math inline">\({\bf
mu}\)</span> and <span class="math inline">\(\Sigma\)</span> as a
function of covariates <span class="math inline">\(c_{ik}\)</span>’s:
<span class="math display">\[
{\bf \mu}_{i}={\bf \mu}+\sum_k c_{ik} {\bf \beta_k}, \
\Sigma_{i}=\Sigma +\sum_k c_{ik} {\bf \gamma_k}
\]</span> This leads to the following moment-based regression:</p>
<p><span class="math display">\[
x_{ij} = s_i (\mu_j + \sum_k c_{ik} \beta_k) + \epsilon_{ij}
\]</span></p>
<p><span class="math display">\[(x_{ij} - s_i \mu_{ij})^2 = s_i \mu_{ij}
+ s_i^2 (\sigma_{jj} + \sum_k c_{ik} \gamma_k) + \eta_{ij}\]</span>
<span class="math display">\[(x_{ij} - s_i \mu_{ij})(x_{ij'} - s_i
\mu_{ij'}) = s_i^2 (\sigma_{jj'} + \sum_k c_{ik} \theta_k) +
\xi_{ijj'},\]</span></p>
<p>where <span class="math inline">\(\mu_{ij} = \mu_j + \sum_k c_{ik}
\beta_k\)</span>. These allow adjusting for <span class="math inline">\(K\)</span> covariates <span class="math inline">\(c_{ik}\)</span>’s for their effects on the
underlying gene expression mean (<span class="math inline">\(\beta_k\)</span>’s), variance (<span class="math inline">\(\gamma_k\)</span>’s) and covariance (<span class="math inline">\(\theta_k\)</span>’s).</p>
</div>
<div class="section level2">
<h2 id="demonstration-on-real-data">Demonstration on real data<a class="anchor" aria-label="anchor" href="#demonstration-on-real-data"></a>
</h2>
<p>Here, we demonstrates how to adjust for covariates in CS-CORE with
the same dataset as in <a href="CSCORE.html">Getting started</a>.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://changsubiostats.github.io/CS-CORE/">CSCORE</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://satijalab.org/seurat" class="external-link">Seurat</a></span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># wget https://hosted-matrices-prod.s3-us-west-2.amazonaws.com/Single_cell_atlas_of_peripheral_immune_response_to_SARS_CoV_2_infection-25/blish_covid.seu.rds</span></span>
<span></span>
<span><span class="va">pbmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/readRDS.html" class="external-link">readRDS</a></span><span class="op">(</span><span class="st">'blish_covid.seu.rds'</span><span class="op">)</span></span>
<span><span class="va">pbmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://satijalab.github.io/seurat-object/reference/UpdateSeuratObject.html" class="external-link">UpdateSeuratObject</a></span><span class="op">(</span><span class="va">pbmc</span><span class="op">)</span> <span class="co"># update the obsolete Seurat object</span></span>
<span><span class="va">pbmc_B</span> <span class="op">=</span> <span class="va">pbmc</span><span class="op">[</span>,<span class="va">pbmc</span><span class="op">$</span><span class="va">cell.type.coarse</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="st">'B'</span><span class="op">]</span></span>
<span><span class="va">mean_exp</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/colSums.html" class="external-link">rowMeans</a></span><span class="op">(</span><span class="va">pbmc_B</span><span class="op">@</span><span class="va">assays</span><span class="op">$</span><span class="va">RNA</span><span class="op">@</span><span class="va">counts</span><span class="op">/</span><span class="va">pbmc_B</span><span class="op">$</span><span class="va">nCount_RNA</span><span class="op">)</span></span>
<span><span class="va">genes_selected</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort.int</a></span><span class="op">(</span><span class="va">mean_exp</span>, decreasing <span class="op">=</span> <span class="cn">T</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">200</span><span class="op">]</span></span>
<span><span class="va">pbmc_B_healthy</span> <span class="op">&lt;-</span> <span class="va">pbmc_B</span><span class="op">[</span>, <span class="va">pbmc_B</span><span class="op">$</span><span class="va">Status</span> <span class="op">==</span> <span class="st">"Healthy"</span><span class="op">]</span></span></code></pre></div>
<p>This dataset comes with detailed cell-level covariates:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">pbmc_B_healthy</span><span class="op">@</span><span class="va">meta.data</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1] "orig.ident"       "nCount_RNA"       "nFeature_RNA"     "percent.mt"       "percent.rps"      "percent.rpl"     </span></span>
<span><span class="co">#&gt;  [7] "percent.rrna"     "nCount_SCT"       "nFeature_SCT"     "SCT_snn_res.1"    "seurat_clusters"  "singler"         </span></span>
<span><span class="co">#&gt; [13] "Admission.level"  "cell.type.fine"   "cell.type.coarse" "cell.type"        "IFN1"             "HLA1"            </span></span>
<span><span class="co">#&gt; [19] "Donor.orig"       "Donor.full"       "Donor"            "Status"           "Sex"              "DPS"             </span></span>
<span><span class="co">#&gt; [25] "DTF"              "Admission"        "Ventilated"</span></span></code></pre></div>
<p>As an example, we choose to adjust for <code>Sex</code> and
<code>percent.mt</code>. To run CS-CORE with covariate adjustment,
use</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CSCORE_result_adj</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CSCORE.html">CSCORE</a></span><span class="op">(</span><span class="va">pbmc_B_healthy</span>,</span>
<span>                            genes <span class="op">=</span> <span class="va">genes_selected</span>,</span>
<span>                            covariate_names <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">'percent.mt'</span>, <span class="st">'Sex'</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt; [INFO] Adjust for covariates: percent.mt, Sex </span></span>
<span><span class="co">#&gt; [INFO] Variables in the design matrix: percent.mt, SexM </span></span>
<span><span class="co">#&gt; [INFO] IRLS converged after 3 iterations.</span></span>
<span><span class="co">#&gt; [INFO] Starting WLS for covariance at Thu Jun 26 17:09:48 2025</span></span>
<span><span class="co">#&gt; [INFO] 1 among 200 genes have invalid variance estimates. Their co-expressions with other genes were set to 0.</span></span>
<span><span class="co">#&gt; [INFO] 0.0854% co-expression estimates were greater than 1 and were set to 1.</span></span>
<span><span class="co">#&gt; [INFO] 0.0101% co-expression estimates were smaller than -1 and were set to -1.</span></span>
<span><span class="co">#&gt; [INFO] Finished WLS. Elapsed time: 1.8762 seconds.</span></span></code></pre></div>
<p>By default, <code>CSCORE</code> extracts the covariates from the
Seurat object and construct a design matrix with scaled and centered
covariates. To understand the detailed impact of covariate adjustment,
we also compare with the results without covariate adjustment.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">CSCORE_result</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/CSCORE.html">CSCORE</a></span><span class="op">(</span><span class="va">pbmc_B_healthy</span>, genes <span class="op">=</span> <span class="va">genes_selected</span><span class="op">)</span></span>
<span><span class="co">#&gt; [INFO] IRLS converged after 3 iterations.</span></span>
<span><span class="co">#&gt; [INFO] Starting WLS for covariance at Thu Jun 26 17:09:50 2025</span></span>
<span><span class="co">#&gt; [INFO] 0.0101% co-expression estimates were greater than 1 and were set to 1.</span></span>
<span><span class="co">#&gt; [INFO] 0.0000% co-expression estimates were smaller than -1 and were set to -1.</span></span>
<span><span class="co">#&gt; [INFO] Finished WLS. Elapsed time: 1.2249 seconds.</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># compare co-expression estimates for a random set of gene pairs</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">42002</span><span class="op">)</span></span>
<span><span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">genes_selected</span><span class="op">)</span></span>
<span><span class="va">random_pairs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lower.tri.html" class="external-link">upper.tri</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="va">p</span><span class="op">^</span><span class="fl">2</span>, <span class="va">p</span>, <span class="va">p</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">CSCORE_result</span><span class="op">$</span><span class="va">est</span><span class="op">[</span><span class="va">random_pairs</span><span class="op">]</span>,</span>
<span>     <span class="va">CSCORE_result_adj</span><span class="op">$</span><span class="va">est</span><span class="op">[</span><span class="va">random_pairs</span><span class="op">]</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">'CS-CORE'</span>, ylab <span class="op">=</span> <span class="st">'CS-CORE adjusted'</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Co-expression estimates'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/figrho-1.png"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">CSCORE_result</span><span class="op">$</span><span class="va">test_stat</span><span class="op">[</span><span class="va">random_pairs</span><span class="op">]</span>,</span>
<span>     <span class="va">CSCORE_result_adj</span><span class="op">$</span><span class="va">test_stat</span><span class="op">[</span><span class="va">random_pairs</span><span class="op">]</span>,</span>
<span>     xlab <span class="op">=</span> <span class="st">'CS-CORE'</span>, ylab <span class="op">=</span> <span class="st">'CS-CORE adjusted'</span>,</span>
<span>     main <span class="op">=</span> <span class="st">'Test_stat'</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/abline.html" class="external-link">abline</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span>,col<span class="op">=</span><span class="st">'red'</span><span class="op">)</span></span></code></pre></div>
<p><img src="figure/figt-1.png"></p>
<p>It seems that the co-expression for most gene pairs are similar with
and without covariate adjustment. We recommend users to sanity check
this and examine the impact of covariate adjustment on co-expression
inference.</p>
</div>
<div class="section level2">
<h2 id="advanced-topics">Advanced topics<a class="anchor" aria-label="anchor" href="#advanced-topics"></a>
</h2>
<p>The application above adjusts for covariates in the underlying
expression levels’ mean, variance, and covariance. For users who wish to
have more fine-grained control on the regression models, we provide two
additional parameters: <code>adjust_setting</code> and
<code>covariate_level</code>.</p>
<div class="section level3">
<h3 id="adjust_setting">
<code>adjust_setting</code><a class="anchor" aria-label="anchor" href="#adjust_setting"></a>
</h3>
<p>We provide these two options in <a href="CSCORE_IRLS_cpp.html">CSCORE_IRLS_cpp</a>, which is the function
underlying <code>CSCORE</code>. <code>adjust_setting</code> allows you
to choose which regression model to adjust covariates for. For example,
if <code>adjust_setting=c(mean = T, var = F, covar = T)</code>, this is
equivalent to running the following regressions:</p>
<p><span class="math display">\[
x_{ij} = s_i (\mu_j + \sum_k c_{ik} \beta_k) + \epsilon_{ij}
\]</span></p>
<p><span class="math display">\[
(x_{ij} - s_i \mu_{ij})^2 = s_i \mu_{ij} + s_i^2 \sigma_{jj}  +
\eta_{ij}
\]</span></p>
<p><span class="math display">\[
(x_{ij} - s_i \mu_{ij})(x_{ij'} - s_i \mu_{ij'}) = s_i^2
(\sigma_{jj'} + \sum_k c_{ik} \theta_k) + \xi_{ijj'},
\]</span></p>
</div>
<div class="section level3">
<h3 id="covariate_level">
<code>covariate_level</code><a class="anchor" aria-label="anchor" href="#covariate_level"></a>
</h3>
<p>In the adjustment models above, we assume <span class="math inline">\({\bf z_{i}}\sim F_p({\bf \mu}, \Sigma),
x_{ij}|z_{ij} \sim \text{Poisson}(s_i z_{ij})\)</span> and <span class="math inline">\({\bf \mu}_{i}={\bf \mu}+\sum_k c_{ik} {\bf
\beta_k}\)</span>. This implies that the underlying mean expression is
associated with covariates.</p>
<p>Another possible model is to assume <span class="math inline">\(\text{Poisson}(s_i z_{ij} + \sum_k c_{ik} {\bf
\beta_k})\)</span>, which implies that the covariates operate in the
measurement process, independent of underlying gene expression. Even
though we think the default model is more natural, we allow for this
flexibility by specifying <code>covariate_level = "x"</code>. This will
run <span class="math display">\[
x_{ij} = s_i \mu_j  + \sum_k c_{ik} \beta_k + \epsilon_{ij},
\]</span> and similarly for variance and covariance.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Chang Su, Zichun Xu, Xinning Shan.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.3.</p>
</div>

    </footer>
</div>





  </body>
</html>
